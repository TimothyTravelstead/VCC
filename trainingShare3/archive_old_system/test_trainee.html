<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trainee Screen Sharing Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #e8f5e8;
        }
        .panel {
            border: 3px solid #388e3c;
            padding: 20px;
            border-radius: 10px;
            background-color: white;
        }
        
        video {
            width: 100%;
            max-width: 500px;
            height: auto;
            border: 2px solid #388e3c;
            margin: 15px 0;
            border-radius: 8px;
            background-color: #f1f8e9;
        }
        
        button {
            padding: 12px 20px;
            margin: 8px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        
        .btn-primary { background: #388e3c; color: white; }
        .btn-success { background: #1976d2; color: white; }
        .btn-warning { background: #f57c00; color: white; }
        
        .debug-log {
            background: #f5f5f5;
            border: 2px solid #ccc;
            padding: 15px;
            margin: 15px 0;
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            border-radius: 8px;
        }
        
        .status {
            padding: 12px;
            margin: 15px 0;
            border-radius: 6px;
            font-weight: bold;
        }
        .status.success { background: #c8e6c9; border: 2px solid #4caf50; color: #1b5e20; }
        .status.error { background: #ffcdd2; border: 2px solid #f44336; color: #b71c1c; }
        .status.warning { background: #fff3e0; border: 2px solid #ff9800; color: #e65100; }
        
        h1 { color: #388e3c; text-align: center; }
        h2 { color: #388e3c; }
        
        .shared-screen-notice {
            background: #e3f2fd;
            border: 2px solid #2196f3;
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            text-align: center;
            font-size: 16px;
            color: #0d47a1;
        }
    </style>
</head>
<body>
    <h1>ðŸ“º TRAINEE INTERFACE</h1>
    <p style="text-align: center; font-size: 18px; color: #666;">
        <strong>Instructions:</strong> Open this page in Safari. Make sure trainer page is open in Chrome.
    </p>
    
    <div class="panel">
        <h2>Trainee View</h2>
        <div id="traineeStatus" class="status warning">Not initialized</div>
        
        <div id="sharedScreenNotice" class="shared-screen-notice" style="display: none;">
            ðŸŽ¥ Trainer's screen will appear below when sharing starts
        </div>
        
        <video id="remoteVideo" autoplay poster="poster.png">
            <source src="" type="video/mp4">
            Trainer's shared screen will appear here
        </video>
        
        <div>
            <button id="initBtn" class="btn-primary">Initialize Trainee</button>
        </div>
        
        <h3>Debug Information</h3>
        <div>
            <button id="clearLogsBtn" class="btn-warning">Clear Logs</button>
            <button id="checkRoomBtn" class="btn-success">Check Room Status</button>
            <button id="checkSignalsBtn" class="btn-success">Check Signal Files</button>
        </div>
        
        <h3>Trainee Debug Log</h3>
        <div id="debugLog" class="debug-log"></div>
        
        <h3>Room/Signal Status</h3>
        <div id="roomStatus" class="debug-log" style="height: 150px;"></div>
    </div>

    <!-- Hidden fields for system compatibility -->
    <input type="hidden" id="volunteerID" value="TestTrainee">
    <input type="hidden" id="trainerID" value="TestTrainer">
    <input type="hidden" id="traineeID" value="TestTrainee">
    <input type="hidden" id="trainer" value="0">
    <input type="hidden" id="trainee" value="1">

    <!-- Include required scripts -->
    <script src="../LibraryScripts/Ajax.js"></script>
    <script src="screenSharingControlMulti.js"></script>
    
    <script>
        // Set up EventSource for trainee
        window.newChat = {
            source: new EventSource('../vccFeed.php?reset=1')
        };
        
        let traineeInstance = null;
        
        // Debug logging helper
        function logToPanel(message, type = 'info') {
            const panel = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            panel.textContent += logEntry;
            panel.scrollTop = panel.scrollHeight;
        }
        
        function updateStatus(message, type = 'warning') {
            const status = document.getElementById('traineeStatus');
            status.textContent = message;
            status.className = `status ${type}`;
        }
        
        // EventSource debugging
        window.newChat.source.onopen = function(event) {
            console.log('EventSource opened:', event);
            logToPanel('EventSource connected to vccFeed.php', 'info');
        };
        
        window.newChat.source.onerror = function(event) {
            console.error('EventSource error:', event);
            logToPanel('EventSource error: ' + JSON.stringify(event), 'error');
        };
        
        window.newChat.source.onmessage = function(event) {
            console.log('EventSource message:', event);
            logToPanel('EventSource message: ' + event.data, 'info');
        };
        
        window.newChat.source.addEventListener('screenShare', function(event) {
            console.log('EventSource screenShare event:', event);
            logToPanel('ðŸŽ¥ EventSource screenShare: ' + event.data, 'info');
            
            // Show notice when screen share events are received
            document.getElementById('sharedScreenNotice').style.display = 'block';
        });
        
        // Initialize trainee
        document.getElementById('initBtn').addEventListener('click', async () => {
            try {
                updateStatus('Authenticating as trainee...', 'warning');
                logToPanel('Starting trainee authentication', 'info');
                
                const authResponse = await fetch('test_auth.php?userID=TestTrainee&trainee=1');
                const authData = await authResponse.json();
                logToPanel(`Authentication response: ${JSON.stringify(authData)}`, 'info');
                
                if (authData.dbError) {
                    logToPanel(`Database warning: ${authData.dbError}`, 'warning');
                }
                
                updateStatus('Initializing trainee instance...', 'warning');
                logToPanel('Creating MultiTraineeScreenSharing instance', 'info');
                
                traineeInstance = new MultiTraineeScreenSharing({
                    role: 'trainee',
                    trainerId: 'TestTrainer',
                    participantId: 'TestTrainee',
                    roomId: 'TestTrainer'
                });
                
                updateStatus('Trainee initialized - waiting for trainer', 'success');
                logToPanel('Trainee ready - waiting for trainer to share screen', 'info');
                
            } catch (error) {
                updateStatus(`Error: ${error.message}`, 'error');
                logToPanel(`Initialization error: ${error.message}`, 'error');
                console.error('Trainee initialization failed:', error);
            }
        });
        
        // Clear logs
        document.getElementById('clearLogsBtn').addEventListener('click', () => {
            document.getElementById('debugLog').textContent = '';
            document.getElementById('roomStatus').textContent = '';
            logToPanel('Logs cleared', 'info');
        });
        
        // Check room status
        document.getElementById('checkRoomBtn').addEventListener('click', () => {
            fetch('roomManager.php?action=room-status&roomId=TestTrainer')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('roomStatus').textContent = JSON.stringify(data, null, 2);
                    logToPanel('Room status updated', 'info');
                })
                .catch(error => {
                    document.getElementById('roomStatus').textContent = `Error: ${error.message}`;
                    logToPanel(`Room status error: ${error.message}`, 'error');
                });
        });
        
        // Check signal files
        document.getElementById('checkSignalsBtn').addEventListener('click', () => {
            Promise.all([
                fetch('Signals/room_TestTrainer.json').then(r => r.json()).catch(e => ({error: e.message})),
                fetch('Signals/participant_TestTrainer.txt').then(r => r.text()).catch(e => 'No file'),
                fetch('Signals/participant_TestTrainee.txt').then(r => r.text()).catch(e => 'No file')
            ]).then(([room, trainerSignals, traineeSignals]) => {
                const status = {
                    room,
                    trainerSignals,
                    traineeSignals
                };
                document.getElementById('roomStatus').textContent = JSON.stringify(status, null, 2);
                logToPanel('Signal files checked', 'info');
            });
        });
        
        // Monitor debug logs from screen sharing instance
        setInterval(() => {
            if (window.screenSharingDebugLog && window.screenSharingDebugLog.length > 0) {
                const logs = window.screenSharingDebugLog.splice(0);
                logs.forEach(log => {
                    logToPanel(`${log.stage}: ${JSON.stringify(log.data)}`, 'debug');
                });
            }
        }, 1000);
        
        // Enhanced video monitoring for trainee
        const remoteVideo = document.getElementById('remoteVideo');
        remoteVideo.onloadstart = () => logToPanel('ðŸŽ¥ Video loading started', 'info');
        remoteVideo.oncanplay = () => logToPanel('ðŸŽ¥ Video ready to play', 'info');
        remoteVideo.onplay = () => logToPanel('ðŸŽ¥ Video started playing', 'info');
        remoteVideo.onerror = (e) => logToPanel(`ðŸŽ¥ Video error: ${e.message}`, 'error');
        
        // Initial log
        logToPanel('Trainee page loaded. Click "Initialize Trainee" to begin.', 'info');
        logToPanel('Make sure trainer is initialized in Chrome first.', 'info');
    </script>
</body>
</html>