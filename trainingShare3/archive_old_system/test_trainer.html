<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trainer Screen Sharing Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #e3f2fd;
        }
        .panel {
            border: 3px solid #1976d2;
            padding: 20px;
            border-radius: 10px;
            background-color: white;
        }
        
        video {
            width: 100%;
            max-width: 500px;
            height: auto;
            border: 2px solid #1976d2;
            margin: 15px 0;
            border-radius: 8px;
        }
        
        button {
            padding: 12px 20px;
            margin: 8px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        
        .btn-primary { background: #1976d2; color: white; }
        .btn-success { background: #388e3c; color: white; }
        .btn-danger { background: #d32f2f; color: white; }
        .btn-warning { background: #f57c00; color: white; }
        
        .debug-log {
            background: #f5f5f5;
            border: 2px solid #ccc;
            padding: 15px;
            margin: 15px 0;
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            border-radius: 8px;
        }
        
        .status {
            padding: 12px;
            margin: 15px 0;
            border-radius: 6px;
            font-weight: bold;
        }
        .status.success { background: #c8e6c9; border: 2px solid #4caf50; color: #1b5e20; }
        .status.error { background: #ffcdd2; border: 2px solid #f44336; color: #b71c1c; }
        .status.warning { background: #fff3e0; border: 2px solid #ff9800; color: #e65100; }
        
        h1 { color: #1976d2; text-align: center; }
        h2 { color: #1976d2; }
    </style>
</head>
<body>
    <h1>ðŸŽ“ TRAINER INTERFACE</h1>
    <p style="text-align: center; font-size: 18px; color: #666;">
        <strong>Instructions:</strong> Open this page in Chrome. Open the trainee page in Safari.
    </p>
    
    <div class="panel">
        <h2>Trainer Controls</h2>
        <div id="trainerStatus" class="status warning">Not initialized</div>
        
        <video id="localVideo" autoplay muted>
            <source src="" type="video/mp4">
            Your browser does not support video.
        </video>
        
        <div>
            <button id="initBtn" class="btn-primary">Initialize Trainer</button>
            <button id="startSharingBtn" class="btn-success" disabled>Start Screen Share</button>
            <button id="stopSharingBtn" class="btn-danger" disabled>Stop Screen Share</button>
        </div>
        
        <h3>Debug Information</h3>
        <div>
            <button id="clearLogsBtn" class="btn-warning">Clear Logs</button>
            <button id="checkRoomBtn" class="btn-primary">Check Room Status</button>
            <button id="checkSignalsBtn" class="btn-primary">Check Signal Files</button>
        </div>
        
        <h3>Trainer Debug Log</h3>
        <div id="debugLog" class="debug-log"></div>
        
        <h3>Room/Signal Status</h3>
        <div id="roomStatus" class="debug-log" style="height: 150px;"></div>
    </div>

    <!-- Hidden fields for system compatibility -->
    <input type="hidden" id="volunteerID" value="TestTrainer">
    <input type="hidden" id="trainerID" value="TestTrainer">
    <input type="hidden" id="traineeID" value="TestTrainee">
    <input type="hidden" id="trainer" value="1">
    <input type="hidden" id="trainee" value="0">

    <!-- Include required scripts -->
    <script src="../LibraryScripts/Ajax.js"></script>
    <script src="screenSharingControlMulti.js"></script>
    
    <script>
        // Set up EventSource for trainer
        window.newChat = {
            source: new EventSource('../vccFeed.php?reset=1')
        };
        
        let trainerInstance = null;
        
        // Debug logging helper
        function logToPanel(message, type = 'info') {
            const panel = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            panel.textContent += logEntry;
            panel.scrollTop = panel.scrollHeight;
        }
        
        function updateStatus(message, type = 'warning') {
            const status = document.getElementById('trainerStatus');
            status.textContent = message;
            status.className = `status ${type}`;
        }
        
        // EventSource debugging
        window.newChat.source.onopen = function(event) {
            console.log('EventSource opened:', event);
            logToPanel('EventSource connected to vccFeed.php', 'info');
        };
        
        window.newChat.source.onerror = function(event) {
            console.error('EventSource error:', event);
            logToPanel('EventSource error: ' + JSON.stringify(event), 'error');
        };
        
        window.newChat.source.onmessage = function(event) {
            console.log('EventSource message:', event);
            logToPanel('EventSource message: ' + event.data, 'info');
        };
        
        window.newChat.source.addEventListener('screenShare', function(event) {
            console.log('EventSource screenShare event:', event);
            logToPanel('EventSource screenShare: ' + event.data, 'info');
        });
        
        // Initialize trainer
        document.getElementById('initBtn').addEventListener('click', async () => {
            try {
                updateStatus('Authenticating as trainer...', 'warning');
                logToPanel('Starting trainer authentication', 'info');
                
                const authResponse = await fetch('test_auth.php?userID=TestTrainer&trainer=1');
                const authData = await authResponse.json();
                logToPanel(`Authentication response: ${JSON.stringify(authData)}`, 'info');
                
                if (authData.dbError) {
                    logToPanel(`Database warning: ${authData.dbError}`, 'warning');
                }
                
                updateStatus('Initializing trainer instance...', 'warning');
                logToPanel('Creating MultiTraineeScreenSharing instance', 'info');
                
                trainerInstance = new MultiTraineeScreenSharing({
                    role: 'trainer',
                    trainerId: 'TestTrainer',
                    participantId: 'TestTrainer',
                    roomId: 'TestTrainer'
                });
                
                updateStatus('Trainer initialized successfully', 'success');
                document.getElementById('startSharingBtn').disabled = false;
                logToPanel('Trainer ready - you can now start screen sharing', 'info');
                
            } catch (error) {
                updateStatus(`Error: ${error.message}`, 'error');
                logToPanel(`Initialization error: ${error.message}`, 'error');
                console.error('Trainer initialization failed:', error);
            }
        });
        
        // Start screen sharing
        document.getElementById('startSharingBtn').addEventListener('click', async () => {
            if (trainerInstance) {
                try {
                    updateStatus('Starting screen share...', 'warning');
                    logToPanel('Starting screen sharing process', 'info');
                    
                    await trainerInstance.startScreenSharing();
                    
                    updateStatus('Screen sharing started successfully', 'success');
                    document.getElementById('stopSharingBtn').disabled = false;
                    logToPanel('Screen sharing is now active', 'info');
                    
                } catch (error) {
                    updateStatus(`Screen share error: ${error.message}`, 'error');
                    logToPanel(`Screen share error: ${error.message}`, 'error');
                    console.error('Screen sharing failed:', error);
                }
            } else {
                logToPanel('No trainer instance - click Initialize first', 'error');
            }
        });
        
        // Stop screen sharing
        document.getElementById('stopSharingBtn').addEventListener('click', () => {
            if (trainerInstance) {
                try {
                    trainerInstance.stopScreenSharing();
                    updateStatus('Screen sharing stopped', 'warning');
                    document.getElementById('stopSharingBtn').disabled = true;
                    logToPanel('Screen sharing stopped', 'info');
                } catch (error) {
                    updateStatus(`Error: ${error.message}`, 'error');
                    logToPanel(`Stop error: ${error.message}`, 'error');
                }
            }
        });
        
        // Clear logs
        document.getElementById('clearLogsBtn').addEventListener('click', () => {
            document.getElementById('debugLog').textContent = '';
            document.getElementById('roomStatus').textContent = '';
            logToPanel('Logs cleared', 'info');
        });
        
        // Check room status
        document.getElementById('checkRoomBtn').addEventListener('click', () => {
            fetch('roomManager.php?action=room-status&roomId=TestTrainer')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('roomStatus').textContent = JSON.stringify(data, null, 2);
                    logToPanel('Room status updated', 'info');
                })
                .catch(error => {
                    document.getElementById('roomStatus').textContent = `Error: ${error.message}`;
                    logToPanel(`Room status error: ${error.message}`, 'error');
                });
        });
        
        // Check signal files
        document.getElementById('checkSignalsBtn').addEventListener('click', () => {
            Promise.all([
                fetch('Signals/room_TestTrainer.json').then(r => r.json()).catch(e => ({error: e.message})),
                fetch('Signals/participant_TestTrainer.txt').then(r => r.text()).catch(e => 'No file'),
                fetch('Signals/participant_TestTrainee.txt').then(r => r.text()).catch(e => 'No file')
            ]).then(([room, trainerSignals, traineeSignals]) => {
                const status = {
                    room,
                    trainerSignals,
                    traineeSignals
                };
                document.getElementById('roomStatus').textContent = JSON.stringify(status, null, 2);
                logToPanel('Signal files checked', 'info');
            });
        });
        
        // Monitor debug logs from screen sharing instance
        setInterval(() => {
            if (window.screenSharingDebugLog && window.screenSharingDebugLog.length > 0) {
                const logs = window.screenSharingDebugLog.splice(0);
                logs.forEach(log => {
                    logToPanel(`${log.stage}: ${JSON.stringify(log.data)}`, 'debug');
                });
            }
        }, 1000);
        
        // Initial log
        logToPanel('Trainer page loaded. Click "Initialize Trainer" to begin.', 'info');
    </script>
</body>
</html>