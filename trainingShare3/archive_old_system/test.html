<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Screen Sharing Test Page</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .panel {
            border: 2px solid #ccc;
            padding: 15px;
            border-radius: 8px;
        }
        .trainer { border-color: #007bff; }
        .trainee { border-color: #28a745; }
        
        video {
            width: 100%;
            max-width: 400px;
            height: auto;
            border: 1px solid #ddd;
            margin: 10px 0;
        }
        
        button {
            padding: 10px 15px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        
        .debug-log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin: 10px 0;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status.success { background: #d4edda; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; border: 1px solid #f5c6cb; }
        .status.warning { background: #fff3cd; border: 1px solid #ffeaa7; }
    </style>
</head>
<body>
    <h1>Training Screen Sharing Test</h1>
    
    <div class="container">
        <!-- Trainer Panel -->
        <div class="panel trainer">
            <h2>Trainer</h2>
            <div id="trainerStatus" class="status">Not initialized</div>
            
            <video id="localVideo" autoplay muted>
                <source src="" type="video/mp4">
                Your browser does not support video.
            </video>
            
            <div>
                <button id="initTrainerBtn" class="btn-primary">Initialize as Trainer</button>
                <button id="startSharingBtn" class="btn-success" disabled>Start Screen Share</button>
                <button id="stopSharingBtn" class="btn-danger" disabled>Stop Screen Share</button>
            </div>
            
            <h3>Trainer Debug Log</h3>
            <div id="trainerDebugLog" class="debug-log"></div>
        </div>
        
        <!-- Trainee Panel -->
        <div class="panel trainee">
            <h2>Trainee</h2>
            <div id="traineeStatus" class="status">Not initialized</div>
            
            <video id="remoteVideo" autoplay poster="poster.png">
                <source src="" type="video/mp4">
                Your browser does not support video.
            </video>
            
            <div>
                <button id="initTraineeBtn" class="btn-primary">Initialize as Trainee</button>
            </div>
            
            <h3>Trainee Debug Log</h3>
            <div id="traineeDebugLog" class="debug-log"></div>
        </div>
    </div>
    
    <!-- Test Controls -->
    <div style="margin-top: 30px; padding: 20px; border: 2px solid #6c757d; border-radius: 8px;">
        <h3>Test Controls</h3>
        <button id="clearLogsBtn" class="btn-primary">Clear Debug Logs</button>
        <button id="checkRoomBtn" class="btn-primary">Check Room Status</button>
        <button id="checkSignalsBtn" class="btn-primary">Check Signal Files</button>
        
        <h4>Room Status</h4>
        <div id="roomStatus" class="debug-log" style="height: 100px;"></div>
    </div>

    <!-- Hidden fields to simulate main system -->
    <input type="hidden" id="volunteerID" value="TestTrainer">
    <input type="hidden" id="trainerID" value="TestTrainer">
    <input type="hidden" id="traineeID" value="TestTrainee">
    <input type="hidden" id="trainer" value="1">
    <input type="hidden" id="assignedTraineeIDs" value="TestTrainee">
    <input type="hidden" id="trainee" value="">

    <!-- Include required scripts -->
    <script src="../LibraryScripts/Ajax.js"></script>
    <script src="screenSharingControlMulti.js"></script>
    
    <script>
        // Mock ChatMonitor for testing
        window.newChat = {
            source: new EventSource('../vccFeed.php?reset=1')
        };
        
        // Add debug logging for EventSource events
        window.newChat.source.onopen = function(event) {
            console.log('EventSource opened:', event);
            logToPanel('trainerDebugLog', 'EventSource connected', 'info');
            logToPanel('traineeDebugLog', 'EventSource connected', 'info');
        };
        
        window.newChat.source.onerror = function(event) {
            console.error('EventSource error:', event);
            logToPanel('trainerDebugLog', 'EventSource error: ' + JSON.stringify(event), 'error');
            logToPanel('traineeDebugLog', 'EventSource error: ' + JSON.stringify(event), 'error');
        };
        
        window.newChat.source.onmessage = function(event) {
            console.log('EventSource message:', event);
            logToPanel('trainerDebugLog', 'EventSource message: ' + event.data, 'info');
            logToPanel('traineeDebugLog', 'EventSource message: ' + event.data, 'info');
        };
        
        // Monitor all EventSource events
        window.newChat.source.addEventListener('screenShare', function(event) {
            console.log('EventSource screenShare event:', event);
            logToPanel('trainerDebugLog', 'EventSource screenShare: ' + event.data, 'info');
            logToPanel('traineeDebugLog', 'EventSource screenShare: ' + event.data, 'info');
        });
        
        let trainerInstance = null;
        let traineeInstance = null;
        
        // Debug logging helpers
        function logToPanel(panelId, message, type = 'info') {
            const panel = document.getElementById(panelId);
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            panel.textContent += logEntry;
            panel.scrollTop = panel.scrollHeight;
        }
        
        function updateStatus(statusId, message, type = 'warning') {
            const status = document.getElementById(statusId);
            status.textContent = message;
            status.className = `status ${type}`;
        }
        
        // Override console.log for trainer instance
        function setupTrainerLogging() {
            const originalLog = console.log;
            const originalError = console.error;
            
            console.log = function(...args) {
                originalLog.apply(console, args);
                if (args[0] && args[0].includes && args[0].includes('SCREEN_SHARING_DEBUG')) {
                    logToPanel('trainerDebugLog', args.join(' '), 'debug');
                }
            };
            
            console.error = function(...args) {
                originalError.apply(console, args);
                logToPanel('trainerDebugLog', args.join(' '), 'error');
            };
        }
        
        // Initialize trainer
        document.getElementById('initTrainerBtn').addEventListener('click', async () => {
            try {
                // Authenticate ONLY as trainer (this will overwrite session)
                updateStatus('trainerStatus', 'Authenticating as trainer...', 'warning');
                const authResponse = await fetch('test_auth.php?userID=TestTrainer&trainer=1');
                const authData = await authResponse.json();
                logToPanel('trainerDebugLog', `Trainer Authentication: ${JSON.stringify(authData)}`, 'info');
                
                // Disable trainee if it was previously initialized since session changed
                if (traineeInstance) {
                    logToPanel('traineeDebugLog', 'Session changed to trainer - trainee instance invalidated', 'warning');
                    updateStatus('traineeStatus', 'Session changed - please re-initialize', 'warning');
                    traineeInstance = null;
                }
                
                // Set up as trainer
                document.getElementById('volunteerID').value = 'TestTrainer';
                document.getElementById('trainer').value = '1';
                document.getElementById('trainee').value = '';
                
                updateStatus('trainerStatus', 'Initializing trainer...', 'warning');
                logToPanel('trainerDebugLog', 'Starting trainer initialization', 'info');
                
                trainerInstance = new MultiTraineeScreenSharing({
                    role: 'trainer',
                    trainerId: 'TestTrainer',
                    participantId: 'TestTrainer',
                    roomId: 'TestTrainer'
                });
                
                updateStatus('trainerStatus', 'Trainer initialized', 'success');
                document.getElementById('startSharingBtn').disabled = false;
                
            } catch (error) {
                updateStatus('trainerStatus', `Error: ${error.message}`, 'error');
                logToPanel('trainerDebugLog', `Error: ${error.message}`, 'error');
            }
        });
        
        // Initialize trainee
        document.getElementById('initTraineeBtn').addEventListener('click', async () => {
            try {
                // Authenticate first
                updateStatus('traineeStatus', 'Authenticating...', 'warning');
                const authResponse = await fetch('test_auth.php?userID=TestTrainee&trainee=1');
                const authData = await authResponse.json();
                logToPanel('traineeDebugLog', `Authentication: ${JSON.stringify(authData)}`, 'info');
                
                // Set up as trainee
                document.getElementById('volunteerID').value = 'TestTrainee';
                document.getElementById('trainer').value = '';
                document.getElementById('trainee').value = '1';
                
                updateStatus('traineeStatus', 'Initializing trainee...', 'warning');
                logToPanel('traineeDebugLog', 'Starting trainee initialization', 'info');
                
                traineeInstance = new MultiTraineeScreenSharing({
                    role: 'trainee',
                    trainerId: 'TestTrainer',
                    participantId: 'TestTrainee',
                    roomId: 'TestTrainer'
                });
                
                updateStatus('traineeStatus', 'Trainee initialized', 'success');
                
            } catch (error) {
                updateStatus('traineeStatus', `Error: ${error.message}`, 'error');
                logToPanel('traineeDebugLog', `Error: ${error.message}`, 'error');
            }
        });
        
        // Start screen sharing
        document.getElementById('startSharingBtn').addEventListener('click', async () => {
            if (trainerInstance) {
                try {
                    updateStatus('trainerStatus', 'Starting screen share...', 'warning');
                    await trainerInstance.startScreenSharing();
                    updateStatus('trainerStatus', 'Screen sharing started', 'success');
                    document.getElementById('stopSharingBtn').disabled = false;
                } catch (error) {
                    updateStatus('trainerStatus', `Error: ${error.message}`, 'error');
                    logToPanel('trainerDebugLog', `Error starting screen share: ${error.message}`, 'error');
                }
            }
        });
        
        // Stop screen sharing
        document.getElementById('stopSharingBtn').addEventListener('click', () => {
            if (trainerInstance) {
                try {
                    trainerInstance.stopScreenSharing();
                    updateStatus('trainerStatus', 'Screen sharing stopped', 'warning');
                    document.getElementById('stopSharingBtn').disabled = true;
                } catch (error) {
                    updateStatus('trainerStatus', `Error: ${error.message}`, 'error');
                }
            }
        });
        
        // Clear logs
        document.getElementById('clearLogsBtn').addEventListener('click', () => {
            document.getElementById('trainerDebugLog').textContent = '';
            document.getElementById('traineeDebugLog').textContent = '';
            document.getElementById('roomStatus').textContent = '';
        });
        
        // Check room status
        document.getElementById('checkRoomBtn').addEventListener('click', () => {
            fetch('roomManager.php?action=room-status&roomId=TestTrainer')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('roomStatus').textContent = JSON.stringify(data, null, 2);
                })
                .catch(error => {
                    document.getElementById('roomStatus').textContent = `Error: ${error.message}`;
                });
        });
        
        // Check signal files
        document.getElementById('checkSignalsBtn').addEventListener('click', () => {
            // Check if signal files exist
            Promise.all([
                fetch('Signals/room_TestTrainer.json').then(r => r.json()).catch(e => ({error: e.message})),
                fetch('Signals/participant_TestTrainer.txt').then(r => r.text()).catch(e => 'No file'),
                fetch('Signals/participant_TestTrainee.txt').then(r => r.text()).catch(e => 'No file')
            ]).then(([room, trainerSignals, traineeSignals]) => {
                const status = {
                    room,
                    trainerSignals,
                    traineeSignals
                };
                document.getElementById('roomStatus').textContent = JSON.stringify(status, null, 2);
            });
        });
        
        // Set up logging
        setupTrainerLogging();
        
        // Monitor debug logs from window.screenSharingDebugLog
        setInterval(() => {
            if (window.screenSharingDebugLog && window.screenSharingDebugLog.length > 0) {
                const logs = window.screenSharingDebugLog.splice(0);
                logs.forEach(log => {
                    const panelId = log.role === 'trainer' ? 'trainerDebugLog' : 'traineeDebugLog';
                    logToPanel(panelId, `${log.stage}: ${JSON.stringify(log.data)}`, 'debug');
                });
            }
        }, 1000);
    </script>
</body>
</html>