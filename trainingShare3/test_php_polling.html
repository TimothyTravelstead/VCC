<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PHP Polling Screen Sharing Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .notice {
            background-color: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border: 1px solid #c3e6cb;
        }
        
        .controls {
            margin: 20px 0;
            padding: 15px;
            background-color: #e9ecef;
            border-radius: 5px;
        }
        
        .controls input, .controls select, .controls button {
            margin: 5px;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        
        .controls button {
            background-color: #28a745;
            color: white;
            cursor: pointer;
        }
        
        .controls button:hover {
            background-color: #218838;
        }
        
        .controls button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        .role-section {
            margin: 20px 0;
            padding: 20px;
            border: 2px solid #ddd;
            border-radius: 5px;
        }
        
        .role-section.trainer {
            border-color: #28a745;
            background-color: #f8fff9;
        }
        
        .role-section.trainee {
            border-color: #007bff;
            background-color: #f8f9ff;
        }
        
        .video-container {
            margin: 20px 0;
            text-align: center;
        }
        
        video {
            max-width: 100%;
            border: 2px solid #ddd;
            border-radius: 5px;
        }
        
        .log {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: #f8f9fa;
            font-family: monospace;
            font-size: 12px;
            margin: 20px 0;
        }
        
        .hidden-fields {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Hidden fields that the system expects -->
    <div class="hidden-fields">
        <input type="hidden" id="volunteerID" value="">
        <input type="hidden" id="currentUserName" value="">
        <input type="hidden" id="trainerID" value="">
        <input type="hidden" id="traineeID" value="">
        <input type="hidden" id="trainer" value="">
        <input type="hidden" id="trainee" value="">
    </div>

    <div class="container">
        <h1>üì° PHP Polling Screen Sharing Test</h1>
        
        <div class="notice">
            <h3>‚úÖ Reliable PHP EventSource + POST System</h3>
            <p>This test uses the proven PHP polling system with EventSource for receiving and POST for sending. Works on any hosting platform with HTTPS support.</p>
        </div>
        
        <div class="controls">
            <h3>Test Setup</h3>
            <label for="testRole">Role:</label>
            <select id="testRole">
                <option value="trainer">Trainer</option>
                <option value="trainee">Trainee</option>
            </select>
            
            <label for="testUserId">User ID:</label>
            <input type="text" id="testUserId" value="TestTrainer" placeholder="Enter user ID">
            
            <label for="testRoomId">Training Room:</label>
            <input type="text" id="testRoomId" value="TestRoom" placeholder="Enter room ID">
            
            <br><br>
            
            <button id="initBtn" onclick="initializeClient()">Initialize Client</button>
            <button id="startShareBtn" onclick="startSharing()" disabled>Start Screen Sharing</button>
            <button id="stopShareBtn" onclick="stopSharing()" disabled>Stop Screen Sharing</button>
            <button onclick="clearLog()">Clear Log</button>
        </div>
        
        <div class="role-section trainer" id="trainerSection" style="display: none;">
            <h3>üë®‚Äçüè´ Trainer Controls</h3>
            <p>As trainer, your screen will be automatically shared to trainees.</p>
            
            <div class="video-container">
                <h4>Local Preview (Your Screen)</h4>
                <video id="localVideo" autoplay muted style="max-width: 400px;"></video>
            </div>
        </div>
        
        <div class="role-section trainee" id="traineeSection" style="display: none;">
            <h3>üë®‚Äçüéì Trainee View</h3>
            <p>You will see the trainer's screen when they start sharing.</p>
            
            <div class="video-container">
                <h4>Trainer's Screen</h4>
                <video id="remoteVideo" autoplay playsInline poster="poster.png" style="max-width: 800px;"></video>
            </div>
        </div>
        
        <div class="log" id="log"></div>
    </div>
    
    <!-- Include the restored PHP polling client -->
    <script src="screenSharingControlMulti.js"></script>
    
    <script>
        let screenSharing = null;
        
        function log(message, level = 'info') {
            const logEl = document.getElementById('log');
            const entry = document.createElement('div');
            entry.style.color = level === 'error' ? '#dc3545' : level === 'success' ? '#28a745' : '#007bff';
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logEl.appendChild(entry);
            logEl.scrollTop = logEl.scrollHeight;
            console.log(message);
        }
        
        function updateRoleUI(role) {
            const trainerSection = document.getElementById('trainerSection');
            const traineeSection = document.getElementById('traineeSection');
            
            if (role === 'trainer') {
                trainerSection.style.display = 'block';
                traineeSection.style.display = 'none';
            } else if (role === 'trainee') {
                trainerSection.style.display = 'none';
                traineeSection.style.display = 'block';
            }
        }
        
        function initializeClient() {
            const role = document.getElementById('testRole').value;
            const userId = document.getElementById('testUserId').value;
            const roomId = document.getElementById('testRoomId').value;
            
            if (!userId || !roomId) {
                alert('Please fill in User ID and Room ID');
                return;
            }
            
            try {
                log(`Initializing PHP polling client as ${role}...`, 'info');
                
                // Set up DOM fields that the system expects
                document.getElementById('volunteerID').value = userId;
                document.getElementById('currentUserName').value = userId;
                
                if (role === 'trainer') {
                    document.getElementById('trainerID').value = userId;
                    document.getElementById('trainer').value = '1';
                    document.getElementById('trainee').value = '';
                } else {
                    document.getElementById('trainerID').value = roomId;
                    document.getElementById('traineeID').value = userId;
                    document.getElementById('trainer').value = '';
                    document.getElementById('trainee').value = '1';
                }
                
                // Create the screen sharing client
                screenSharing = new MultiTraineeScreenSharing({
                    trainerId: roomId,
                    participantId: userId,
                    role: role,
                    roomId: roomId
                });
                
                // Initialize the connection
                screenSharing.initialize().then(() => {
                    log(`Successfully initialized as ${role}!`, 'success');
                    updateRoleUI(role);
                    updateButtons(true, role);
                    
                    if (role === 'trainer') {
                        log('Trainer ready - you can start screen sharing', 'success');
                        document.getElementById('startShareBtn').disabled = false;
                    } else {
                        log('Trainee ready - waiting for trainer to share screen', 'info');
                    }
                }).catch(error => {
                    log(`Initialization failed: ${error.message}`, 'error');
                    console.error('Initialization error:', error);
                });
                
            } catch (error) {
                log(`Setup error: ${error.message}`, 'error');
                console.error('Setup error:', error);
            }
        }
        
        function startSharing() {
            if (!screenSharing) {
                log('Client not initialized', 'error');
                return;
            }
            
            try {
                log('Starting screen sharing...', 'info');
                screenSharing.startScreenShare().then(() => {
                    log('Screen sharing started successfully!', 'success');
                    document.getElementById('startShareBtn').disabled = true;
                    document.getElementById('stopShareBtn').disabled = false;
                }).catch(error => {
                    log(`Failed to start sharing: ${error.message}`, 'error');
                });
            } catch (error) {
                log(`Screen sharing error: ${error.message}`, 'error');
            }
        }
        
        function stopSharing() {
            if (!screenSharing) {
                log('Client not initialized', 'error');
                return;
            }
            
            try {
                screenSharing.stopScreenShare();
                log('Screen sharing stopped by user', 'info');
                document.getElementById('startShareBtn').disabled = false;
                document.getElementById('stopShareBtn').disabled = true;
            } catch (error) {
                log(`Failed to stop sharing: ${error.message}`, 'error');
            }
        }
        
        function updateButtons(initialized, role) {
            document.getElementById('initBtn').disabled = initialized;
            
            if (role === 'trainer') {
                document.getElementById('startShareBtn').style.display = 'inline';
                document.getElementById('stopShareBtn').style.display = 'inline';
            } else {
                document.getElementById('startShareBtn').style.display = 'none';
                document.getElementById('stopShareBtn').style.display = 'none';
            }
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        // Initialize
        updateButtons(false);
        log('PHP Polling Screen Sharing test loaded.', 'info');
        log('This system uses EventSource + POST for reliable communication.', 'info');
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (screenSharing) {
                screenSharing.destroy();
            }
        });
    </script>
</body>
</html>